# 课程所用到的命令

## 一、Docker 入门

安装curl命令

`apt-get install -y curl`

安装Docker

`curl -sSL https://get.docker.com/ | sh`

查看Docker命令帮助：

`docker —help`

启动第一个容器

`docker pull busybox`

`docker run -it --rm busybox echo “hello world”`


## 二、Dockerfile介绍

配置系统环境：

`curl -sSL http://112.126.76.236/config.sh | sh`

oschina [Dockerfile详细介绍](http://t.cn/RU7Jlbf)

github [Dockerfile详细介绍](https://github.com/billycyzhang/Shell/blob/master/Dockerfile%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3.md)

构建base基础镜像：

`git clone https://git.oschina.net/csphere/centos.git`

`cd centos`

`docker build -t csphere/centos:7 .`

构建nginx+php-fpm镜像

```
git clone https://git.oschina.net/csphere/php-fpm.git
cd php-fpm
docker build -t csphere/php-fpm:5.4 .
```

构建Mariadb镜像

```
git clone https://git.oschina.net/csphere/mariadb.git
cd mariadb
docker build -t csphere/mariadb:5.5 .
```

创建mariadb容器

```
docker run -d -p 3306:3306 --name mydb -e DB_USER=myuser -e DB_PASS=mypass --restart=always -v /db-data:/var/lib/mysql csphere/mariadb:5.5
```

构建wordpress镜像

```
git clone https://git.oschina.net/csphere/wordpress.git
cd wordpress
docker build -t csphere/wordpress:4.3 .
```

创建Wordpress容器

```
docker run -d -p 80:80 --name myblog --restart=always -e WORDPRESS_DB_USER=myuser -e WORDPRESS_DB_PASSWORD=mypass -e WORDPRESS_DB_HOST=192.168.42.1 -v /data/logs:/var/log/nginx csphere/wordpress:4.3
```

## 三、Docker Registry管理

oschina [安装配置介绍](http://t.cn/RU76iZj)

github [安装配置介绍](https://github.com/billycyzhang/Shell/blob/master/%E7%AE%80%E5%8D%95%E6%90%9E%E5%AE%9A%E5%B8%A6SSL%E7%9A%84Registry.md)

`docker pull reg.changan.com:5000/registry:2.1.1`

`mkdir my-registry`

生成证书

```
mkdir certs
cd certs
openssl req -x509 -days 3650 -subj '/CN=reg.domain.com/' -nodes -newkey rsa:2048 -keyout domain.key -out domain.crt
```

生成密码

```
mkdir auth
docker run --entrypoint htpasswd reg.changan.com:5000/registry:2.1.1 -Bbn testuser password > auth/htpasswd
```

创建registry容器

```
docker run -d -p 8080:5000 --restart=always --name registry \
  -v `pwd`/auth:/auth \
  -e "REGISTRY_AUTH=htpasswd" \
  -e "REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm" \
  -e REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd \
  -v `pwd`/certs:/certs \
  -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \
  -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \
  -v /registry:/var/lib/registry \
  reg.changan.com:5000/registry:2.1.1
```
配置Registry证书

`mkdir /etc/docker/certs.d/reg.domain.com:8080`

`cp /root/certs/domain.crt /etc/docker/certs.d/reg.domain.com:8080`

```
docker tag centos:7.1.1503 reg.domain.com:8080/centos:7.1.1503
docker login reg.domain.com:8080
docker push reg.domain.com:8080/centos:7.1.1503
```

## 四、监控报警 

下载镜像

```
docker pull reg.changan.com:5000/csphere:0.13.0
docker tag reg.changan.com:5000/csphere:0.13.0 csphere/csphere:0.13.0
```
创建监控报警平台

```
curl -SsL -o /tmp/csphere-install.sh https://csphere.cn/static/csphere-install-v2.sh
sudo env ROLE=controller CSPHERE_VERSION=0.13.0 /bin/sh /tmp/csphere-install.sh
```
获取服务器公网ip地址：

`ifconfig eth1`

打开浏览器：http://$eth1:1016,注册用户，设置密码并登陆

1.设置SMTP服务器：smtp.exmail.qq.com:465

2.设置SMTP账号：zcy@nicescale.com

3.设置告警联系人：zcy@nicescale.com

4.设置告警策略：主机OR容器

安装ab命令

`apt-get install -y apache2-utils`

模拟压力：

`ab -n 1000 -c 10 http://<your_ip>/`


## 五、日志管理

构建elk镜像

```
docker pull reg.changan.com:5000/elk
docker tag reg.changan.com:5000/elk sebp/elk
git clone https://git.oschina.net/csphere/elk.git
cd elk
docker build -t csphere/elk .
```

启动elk容器

```
docker run -d -p 5000:5000 -p 9200:9200 -p 5601:5601 -e ES_MIX_MEM=64m -e ES_MAX_MEM=512m --name elk --restart=always csphere/elk
```

登陆elk容器

`docker exec -it elk /bin/bash`

配置logstash

`/opt/logstash/bin/logstash -e 'input { stdin { } } output { elasticsearch { host => localhost } }'`

> 输入测试数据`this is a dummy entry`

> 输入`control+c`并回车`enter`

> 浏览测试数据：`http://<your-host>:9200/_search?pretty`

> 登陆kibana管理面板: `http://<your-host>:5601`

构建logstash-forward镜像

```
git clone https://git.oschina.net/csphere/logstash-forward.git
cd logstash-forward
docker build -t csphere/logstash-forward .
```

创建logstash-forward容器

```
docker run -d --name logstash-forward -v /data/logs:/data/logs --link elk:elk csphere/logstash-forward
```

登陆kibana管理面板: `http://<your-host>:5601`,查看日志信息；

## 六、Docker Compose

安装Docker-compose：

```
curl -fsSL http://10.163.17.54/docker-compose > /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
```
官方安装docker-compose方法：

```
curl -L https://github.com/docker/compose/releases/download/1.4.2/docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
```

下载[docker-compose.yml](https://github.com/billycyzhang/Shell/blob/master/docker-compose.yml)文件

`wget http://10.163.17.54/docker-compose.yml`

## 七、Docker 存储

实战AUFS存储：

安装tree命令工具：

`apt-get install -y tree`

创建目录：

```
cd /tmp
mkdir aufs dir1 dir2
echo this is dir1 > dir1/file1
echo this is dir2 > dir2/file2
```
挂载dir1、dir2目录到统一文件系统“aufs”

`mount -t aufs -o br=/tmp/dir1=ro:/tmp/dir2=rw none /tmp/aufs`

- -t 指定文件系统类型
- -o 指定mount传递给文件系统的参数
- ro/rw 设定文件系统的权限：ro=只读；rw=可读写
- none 无设备用none表示

*测试N1*

- dir1-file1权限为只读，测试往里写入数据
- dir2-file2权限为读写，测试往里写入数据

具体情形实战：

dir1+dir2=aufs;如果dir1和dir2中有相同的文件，aufs文件系统中的文件会是dir1还是dir2.

卸载挂载

`umount aufs`

更改dir2-file2为file1，不更改里面内容（this is a dir2）

`mv dir2/file2 /dir2/file1`

重新挂载

`mount -t aufs -o br=/tmp/dir1=ro:/tmp/dir2=rw none /tmp/aufs`

*测试N2*

- dir1,dir2目录下都有file1文件，aufs目录会有几个file1文件，并且file1文件内容会是？

## Overlayfs

使用方法：

`mount -t overlay overlay -olowerdir=/lower, upperdir=/upper, workdir=/work /merged`

- lower：是下层的文件系统，通常是只读的。可以放我们的镜像模板的rootfs 如果我们要对其中某个文件做修改，比如文件A，则overlayfs会将该文件拷贝到/upper目录中修改，也就是实现了文件级别的CoW。

- merged ：是最终叠加后形成的文件系统，也就是用户实际使用看到叠加效果后的文件系统